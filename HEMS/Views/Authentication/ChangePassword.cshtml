@model HEMS.Models.ViewModels.ChangePasswordViewModel
@{
    ViewBag.Title = "Change Password";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="text-center">Change Password</h3>
                    <p class="text-center text-muted">Required for Exam Access</p>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(ViewBag.InfoMessage))
                    {
                        <div class="alert alert-info">
                            @ViewBag.InfoMessage
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(Model.SuccessMessage))
                    {
                        <div class="alert alert-success">
                            @Model.SuccessMessage
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
                    {
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            @Model.ErrorMessage
                        </div>
                    }

                    <div class="alert alert-info">
                        <strong>Password Requirements:</strong>
                        @if (ViewBag.PasswordRequirements != null)
                        {
                            <ul class="mb-0">
                                @foreach (string requirement in ViewBag.PasswordRequirements)
                                {
                                    <li>@requirement</li>
                                }
                            </ul>
                        }
                        else
                        {
                            <ul class="mb-0">
                                <li>At least @HEMS.Models.PasswordPolicy.MinimumLength characters long</li>
                                <li>No more than @HEMS.Models.PasswordPolicy.MaximumLength characters</li>
                                @if (HEMS.Models.PasswordPolicy.RequireUppercase)
                                {
                                    <li>At least one uppercase letter (A-Z)</li>
                                }
                                @if (HEMS.Models.PasswordPolicy.RequireLowercase)
                                {
                                    <li>At least one lowercase letter (a-z)</li>
                                }
                                @if (HEMS.Models.PasswordPolicy.RequireDigit)
                                {
                                    <li>At least one digit (0-9)</li>
                                }
                                @if (HEMS.Models.PasswordPolicy.RequireSpecialCharacter)
                                {
                                    <li>At least one special character</li>
                                }
                                <li>Cannot be a common weak password</li>
                                <li>Cannot reuse any of your last @HEMS.Models.PasswordPolicy.PasswordHistoryCount passwords</li>
                            </ul>
                        }
                    </div>

                    @using (Html.BeginForm("ChangePassword", "Authentication", FormMethod.Post, new { @class = "form" }))
                    {
                        @Html.AntiForgeryToken()
                        
                        <div class="form-group">
                            @Html.LabelFor(m => m.NewPassword, new { @class = "form-label" })
                            @Html.PasswordFor(m => m.NewPassword, new { @class = "form-control", placeholder = "Enter new password" })
                            @Html.ValidationMessageFor(m => m.NewPassword, "", new { @class = "text-danger" })
                        </div>

                        <div class="form-group">
                            @Html.LabelFor(m => m.ConfirmPassword, new { @class = "form-label" })
                            @Html.PasswordFor(m => m.ConfirmPassword, new { @class = "form-control", placeholder = "Confirm new password" })
                            @Html.ValidationMessageFor(m => m.ConfirmPassword, "", new { @class = "text-danger" })
                        </div>

                        <div class="form-group text-center">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-key"></i> Change Password
                            </button>
                        </div>
                    }

                    <div class="text-center mt-3">
                        <small class="text-muted">
                            After changing your password, you will be redirected to the exam dashboard.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/dist/jquery.validate.unobtrusive.min.js"></script>
    
    <script>
        // Add password strength indicator
        $(document).ready(function() {
            $('#NewPassword').on('input', function() {
                var password = $(this).val();
                var strength = 0;
                
                if (password.length >= 6) strength++;
                if (password.match(/[a-z]/)) strength++;
                if (password.match(/[A-Z]/)) strength++;
                if (password.match(/[0-9]/)) strength++;
                if (password.match(/[^a-zA-Z0-9]/)) strength++;
                
                var strengthText = '';
                var strengthClass = '';
                
                switch(strength) {
                    case 0:
                    case 1:
                        strengthText = 'Weak';
                        strengthClass = 'text-danger';
                        break;
                    case 2:
                    case 3:
                        strengthText = 'Medium';
                        strengthClass = 'text-warning';
                        break;
                    case 4:
                    case 5:
                        strengthText = 'Strong';
                        strengthClass = 'text-success';
                        break;
                }
                
                // Remove existing strength indicator
                $('.password-strength').remove();
                
                if (password.length > 0) {
                    $(this).after('<small class="password-strength ' + strengthClass + '">Password strength: ' + strengthText + '</small>');
                }
            });
        });
    </script>
}