@{
    ViewBag.Title = "Take Exam";
    Layout = null;
    var studentExam = ViewBag.StudentExam as HEMS.Models.StudentExam;
    var studentAnswers = ViewBag.StudentAnswers as List<HEMS.Models.StudentAnswer>;
    var remainingMinutes = (int)ViewBag.RemainingTimeMinutes;
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@studentExam.Exam.Title</title>
    <link href="~/lib/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>
    @Html.AntiForgeryToken()

    <!-- Exam Header with Title and Timer -->
    <div class="exam-header">
        <div class="exam-title">@studentExam.Exam.Title</div>
        <div class="exam-timer">
            <span id="timer">@remainingMinutes:00</span>
        </div>
    </div>

    <!-- Main Exam Container -->
    <div class="exam-container">
        <!-- LEFT COLUMN: Question Palette ONLY -->
        <div class="question-palette-column">
            <div class="palette-grid">
                @for (int i = 0; i < studentExam.Exam.Questions.Count; i++)
                {
                    var question = studentExam.Exam.Questions.OrderBy(q => q.QuestionOrder).ElementAt(i);
                    var answer = studentAnswers?.FirstOrDefault(sa => sa.QuestionId == question.QuestionId);
                    var isAnswered = answer?.ChoiceId != null;
                    var isFlagged = answer?.IsFlagged == true;
                    var questionNumber = i + 1;
                    
                    <button class="palette-btn @(questionNumber == 1 ? "current" : "") @(isAnswered ? "answered" : "unanswered") @(isFlagged ? "flagged" : "")" 
                            data-question-id="@question.QuestionId" 
                            data-question-number="@questionNumber"
                            onclick="navigateToQuestion(@questionNumber)">
                        <span class="question-number">@questionNumber</span>
                    </button>
                }
            </div>
        </div>

        <!-- CENTER COLUMN: Question Content ONLY -->
        <div class="question-content-column">
            @foreach (var question in studentExam.Exam.Questions.OrderBy(q => q.QuestionOrder))
            {
                var questionNumber = studentExam.Exam.Questions.OrderBy(q => q.QuestionOrder).ToList().IndexOf(question) + 1;
                var answer = studentAnswers?.FirstOrDefault(sa => sa.QuestionId == question.QuestionId);
                var selectedChoiceId = answer?.ChoiceId;
                var isFlagged = answer?.IsFlagged == true;
                
                <div class="question-container" id="question-@questionNumber" style="@(questionNumber == 1 ? "" : "display: none;")">
                    <!-- Question Text -->
                    <div class="question-text">
                        @Html.Raw(question.QuestionText)
                    </div>
                    
                    <!-- Answer Choices -->
                    <div class="choices-container">
                        @foreach (var choice in question.Choices.OrderBy(c => c.ChoiceOrder))
                        {
                            <div class="choice-item">
                                <label class="choice-label">
                                    <input type="radio" 
                                           name="question-@question.QuestionId" 
                                           value="@choice.ChoiceId"
                                           @(selectedChoiceId == choice.ChoiceId ? "checked" : "")
                                           onchange="saveAnswer(@question.QuestionId, @choice.ChoiceId)">
                                    <span class="choice-text">@choice.ChoiceText</span>
                                </label>
                            </div>
                        }
                    </div>
                    
                    <!-- Navigation Buttons (tight spacing) -->
                    <div class="navigation-buttons">
                        <button type="button" class="nav-btn" id="prevBtn" onclick="previousQuestion()">Previous</button>
                        <button type="button" class="nav-btn" id="nextBtn" onclick="nextQuestion()">Next</button>
                        <button type="button" class="nav-btn submit-btn" onclick="showSubmitConfirmation()">Submit Exam</button>
                    </div>
                    
                    <!-- Flag Button (bottom-left, below navigation) -->
                    <div class="flag-button-container">
                        <button type="button" class="flag-btn" 
                                data-question-id="@question.QuestionId" 
                                data-flagged="@isFlagged.ToString().ToLower()"
                                onclick="toggleFlag(@question.QuestionId, this)">
                            @(isFlagged ? "Remove Flag" : "Flag")
                        </button>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Submit Confirmation Panel (appears at bottom) -->
    <div id="submitConfirmation" class="submit-confirmation" style="display: none;">
        <div class="confirmation-content">
            <p><strong>Are you sure you want to submit your exam?</strong></p>
            <div class="submission-stats">
                <p>Answered: <span id="answeredCount">0</span> questions</p>
                <p>Unanswered: <span id="unansweredCount">0</span> questions</p>
                <p>Flagged: <span id="flaggedCount">0</span> questions</p>
            </div>
            <p class="warning-text"><strong>Warning:</strong> Once submitted, you cannot change your answers.</p>
            <div class="confirmation-buttons">
                <button type="button" class="cancel-btn" onclick="hideSubmitConfirmation()">Cancel</button>
                <button type="button" class="confirm-submit-btn" onclick="confirmSubmit()">Submit Exam</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentQuestion = 1;
        let totalQuestions = @studentExam.Exam.Questions.Count;
        let studentExamId = @studentExam.StudentExamId;
        let remainingSeconds = @remainingMinutes * 60;

        // Timer functionality
        function updateTimer() {
            if (remainingSeconds <= 0) {
                autoSubmitExam();
                return;
            }
            
            let minutes = Math.floor(remainingSeconds / 60);
            let seconds = remainingSeconds % 60;
            document.getElementById('timer').textContent = 
                minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0');
            
            remainingSeconds--;
        }

        // Start timer
        setInterval(updateTimer, 1000);

        // Navigation functions
        function navigateToQuestion(questionNumber) {
            if (questionNumber < 1 || questionNumber > totalQuestions) return;
            
            // Hide current question
            document.getElementById('question-' + currentQuestion).style.display = 'none';
            
            // Show target question
            document.getElementById('question-' + questionNumber).style.display = 'block';
            
            // Update palette - remove current from all, add to target
            document.querySelectorAll('.palette-btn').forEach(btn => {
                btn.classList.remove('current');
            });
            document.querySelector(`[data-question-number="${questionNumber}"]`).classList.add('current');
            
            currentQuestion = questionNumber;
            updateNavigationButtons();
        }

        function previousQuestion() {
            if (currentQuestion > 1) {
                navigateToQuestion(currentQuestion - 1);
            }
        }

        function nextQuestion() {
            if (currentQuestion < totalQuestions) {
                navigateToQuestion(currentQuestion + 1);
            }
        }

        function updateNavigationButtons() {
            document.getElementById('prevBtn').disabled = (currentQuestion === 1);
            document.getElementById('nextBtn').disabled = (currentQuestion === totalQuestions);
        }

        // Answer saving
        function saveAnswer(questionId, choiceId) {
            fetch('/Exam/SaveAnswer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: `studentExamId=${studentExamId}&questionId=${questionId}&choiceId=${choiceId}&__RequestVerificationToken=${document.querySelector('input[name="__RequestVerificationToken"]').value}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update palette to show answered
                    let paletteBtn = document.querySelector(`[data-question-id="${questionId}"]`);
                    paletteBtn.classList.remove('unanswered');
                    paletteBtn.classList.add('answered');
                }
            })
            .catch(error => console.error('Error saving answer:', error));
        }

        // Flag functionality
        function toggleFlag(questionId, button) {
            let isFlagged = button.getAttribute('data-flagged') === 'true';
            let newFlagState = !isFlagged;
            
            fetch('/Exam/ToggleFlag', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: `studentExamId=${studentExamId}&questionId=${questionId}&isFlagged=${newFlagState}&__RequestVerificationToken=${document.querySelector('input[name="__RequestVerificationToken"]').value}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update button
                    button.setAttribute('data-flagged', newFlagState.toString());
                    button.textContent = newFlagState ? 'Remove Flag' : 'Flag';
                    
                    // Update palette
                    let paletteBtn = document.querySelector(`[data-question-id="${questionId}"]`);
                    if (newFlagState) {
                        paletteBtn.classList.add('flagged');
                    } else {
                        paletteBtn.classList.remove('flagged');
                    }
                }
            })
            .catch(error => console.error('Error toggling flag:', error));
        }

        // Submit confirmation functions
        function showSubmitConfirmation() {
            updateSubmissionStats();
            document.getElementById('submitConfirmation').style.display = 'block';
        }

        function hideSubmitConfirmation() {
            document.getElementById('submitConfirmation').style.display = 'none';
        }

        function updateSubmissionStats() {
            let answered = document.querySelectorAll('.palette-btn.answered').length;
            let flagged = document.querySelectorAll('.palette-btn.flagged').length;
            let unanswered = totalQuestions - answered;
            
            document.getElementById('answeredCount').textContent = answered;
            document.getElementById('unansweredCount').textContent = unanswered;
            document.getElementById('flaggedCount').textContent = flagged;
        }

        function confirmSubmit() {
            // Create form to submit exam
            let form = document.createElement('form');
            form.method = 'POST';
            form.action = '/Exam/Submit';
            
            // Add student exam ID
            let examIdInput = document.createElement('input');
            examIdInput.type = 'hidden';
            examIdInput.name = 'studentExamId';
            examIdInput.value = studentExamId;
            form.appendChild(examIdInput);
            
            // Add anti-forgery token
            let tokenInput = document.createElement('input');
            tokenInput.type = 'hidden';
            tokenInput.name = '__RequestVerificationToken';
            tokenInput.value = document.querySelector('input[name="__RequestVerificationToken"]').value;
            form.appendChild(tokenInput);
            
            // Submit form
            document.body.appendChild(form);
            form.submit();
        }

        function autoSubmitExam() {
            alert('Time is up! Your exam will be automatically submitted.');
            confirmSubmit();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateNavigationButtons();
        });
    </script>

    <style>
        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        /* Exam Header */
        .exam-header {
            background: #fff;
            border-bottom: 2px solid #ddd;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 60px;
        }

        .exam-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .exam-timer {
            font-size: 20px;
            font-weight: bold;
            color: #d32f2f;
            background: #fff3cd;
            padding: 8px 15px;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
        }

        /* Main Container */
        .exam-container {
            display: flex;
            margin-top: 60px;
            height: calc(100vh - 60px);
        }

        /* LEFT COLUMN: Question Palette */
        .question-palette-column {
            width: 300px;
            background: #fff;
            border-right: 2px solid #ddd;
            padding: 20px;
            overflow-y: auto;
        }

        /* Question Palette Grid - EXACTLY 5 per row */
        .palette-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 3px;
            margin-bottom: 20px;
        }

        /* Palette Buttons - Rectangular, tight spacing */
        .palette-btn {
            width: 45px;
            height: 35px;
            border: 2px solid #ccc;
            background: white;
            cursor: pointer;
            position: relative;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 0;
            font-size: 12px;
            font-weight: bold;
        }

        .palette-btn:hover {
            border-color: #999;
        }

        .palette-btn .question-number {
            margin-top: 4px;
            color: #333;
        }

        /* Palette States */
        .palette-btn.unanswered {
            background: white;
            border-color: #ccc;
        }

        .palette-btn.answered {
            background: linear-gradient(to bottom, white 50%, #6c757d 50%);
            border-color: #6c757d;
        }

        .palette-btn.current {
            border-color: #007bff;
            border-width: 3px;
        }

        .palette-btn.flagged::after {
            content: '';
            position: absolute;
            top: -2px;
            right: -2px;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid #dc3545;
            border-bottom: 8px solid transparent;
            border-top: 8px solid #dc3545;
        }

        /* After submission states */
        .palette-btn.correct {
            background: linear-gradient(to bottom, white 50%, #28a745 50%);
            border-color: #28a745;
        }

        .palette-btn.incorrect {
            background: linear-gradient(to bottom, white 50%, #dc3545 50%);
            border-color: #dc3545;
        }

        /* CENTER COLUMN: Question Content */
        .question-content-column {
            flex: 1;
            background: #fff;
            padding: 30px;
            overflow-y: auto;
        }

        .question-container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* Question Text */
        .question-text {
            font-size: 18px;
            line-height: 1.6;
            margin-bottom: 30px;
            color: #333;
        }

        /* Answer Choices */
        .choices-container {
            margin-bottom: 20px;
        }

        .choice-item {
            margin-bottom: 15px;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .choice-item:hover {
            background: #f8f9fa;
            border-color: #007bff;
        }

        .choice-item:has(input:checked) {
            background: #e3f2fd;
            border-color: #007bff;
        }

        .choice-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            margin: 0;
            width: 100%;
            font-size: 16px;
        }

        .choice-label input[type="radio"] {
            margin-right: 12px;
            transform: scale(1.2);
        }

        .choice-text {
            flex: 1;
        }

        /* Navigation Buttons - TIGHT spacing */
        .navigation-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .nav-btn {
            padding: 10px 20px;
            border: 1px solid #ccc;
            background: #f8f9fa;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
        }

        .nav-btn:hover {
            background: #e9ecef;
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .submit-btn {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        .submit-btn:hover {
            background: #218838;
        }

        /* Flag Button - Bottom left, below navigation */
        .flag-button-container {
            text-align: left;
            margin-top: 5px;
        }

        .flag-btn {
            padding: 8px 15px;
            border: 1px solid #ffc107;
            background: #fff3cd;
            color: #856404;
            cursor: pointer;
            border-radius: 4px;
            font-size: 13px;
        }

        .flag-btn:hover {
            background: #ffeaa7;
        }

        /* Submit Confirmation Panel - BOTTOM of page */
        .submit-confirmation {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #fff;
            border-top: 3px solid #007bff;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1001;
        }

        .confirmation-content {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }

        .submission-stats {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }

        .submission-stats p {
            margin: 5px 0;
            font-size: 14px;
        }

        .warning-text {
            color: #856404;
            background: #fff3cd;
            padding: 10px;
            border-radius: 4px;
            margin: 15px 0;
        }

        .confirmation-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .cancel-btn {
            padding: 10px 25px;
            border: 1px solid #6c757d;
            background: #f8f9fa;
            cursor: pointer;
            border-radius: 4px;
        }

        .confirm-submit-btn {
            padding: 10px 25px;
            border: 1px solid #28a745;
            background: #28a745;
            color: white;
            cursor: pointer;
            border-radius: 4px;
        }

        .cancel-btn:hover {
            background: #e9ecef;
        }

        .confirm-submit-btn:hover {
            background: #218838;
        }

        /* Responsive Design */
        @@media (max-width: 768px) {
            .question-palette-column {
                width: 250px;
            }
            
            .palette-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .palette-btn {
                width: 40px;
                height: 30px;
                font-size: 11px;
            }
            
            .question-content-column {
                padding: 20px;
            }
            
            .question-text {
                font-size: 16px;
            }
        }

        @@media (max-width: 576px) {
            .exam-container {
                flex-direction: column;
            }
            
            .question-palette-column {
                width: 100%;
                height: 120px;
                padding: 10px;
            }
            
            .palette-grid {
                grid-template-columns: repeat(8, 1fr);
            }
            
            .palette-btn {
                width: 35px;
                height: 25px;
                font-size: 10px;
            }
        }
    </style>
</body>
</html>
