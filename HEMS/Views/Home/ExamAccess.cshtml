@{
    ViewBag.Title = "Exam Access";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@Html.AntiForgeryToken()

<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-clipboard-list"></i> Exam Access
                    </h3>
                </div>
                <div class="card-body">
                    @* Display error messages from TempData *@
                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-danger">
                            <h4><i class="fas fa-exclamation-triangle"></i> Error</h4>
                            <p class="mb-0">@TempData["ErrorMessage"]</p>
                        </div>
                    }
                    else if (ViewBag.ErrorMessage != null)
                    {
                        <div class="alert alert-danger">
                            <h4><i class="fas fa-exclamation-triangle"></i> Error</h4>
                            <p class="mb-0">@ViewBag.ErrorMessage</p>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-success">
                            <h4><i class="fas fa-check-circle"></i> Authentication Complete!</h4>
                            <p class="mb-0">@ViewBag.Message</p>
                        </div>
                    }

                    @if (ViewBag.Student != null)
                    {
                        <div class="row">
                            <div class="col-md-6">
                                <h5>Student Information</h5>
                                <table class="table table-borderless">
                                    <tr>
                                        <td><strong>Student ID:</strong></td>
                                        <td>@ViewBag.Student.IdNumber</td>
                                    </tr>
                                    <tr>
                                        <td><strong>University Email:</strong></td>
                                        <td>@ViewBag.Student.UniversityEmail</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Batch Year:</strong></td>
                                        <td>@ViewBag.Student.BatchYear</td>
                                    </tr>
                                </table>
                            </div>
                            
                            <div class="col-md-6">
                                <h5>Authentication Status</h5>
                                <div class="list-group">
                                    <div class="list-group-item list-group-item-success">
                                        <i class="fas fa-check-circle text-success"></i>
                                        <strong>Phase 1 Completed</strong>
                                        <small class="text-muted d-block">Identity verification successful</small>
                                    </div>
                                    <div class="list-group-item list-group-item-success">
                                        <i class="fas fa-check-circle text-success"></i>
                                        <strong>Phase 2 Completed</strong>
                                        <small class="text-muted d-block">Exam access granted</small>
                                    </div>
                                    <div class="list-group-item list-group-item-success">
                                        <i class="fas fa-shield-alt text-success"></i>
                                        <strong>Password Updated</strong>
                                        <small class="text-muted d-block">Security requirements met</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list"></i> Available Examinations
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Demo Exam Section -->
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> Demo Exam Available:</h6>
                        <p class="mb-0">
                            A demonstration exam is available to test the examination system interface and functionality.
                        </p>
                    </div>

                    <div class="list-group">
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">Computer Science Fundamentals - Demo Exam</h6>
                                <small>Duration: 60 minutes</small>
                            </div>
                            <p class="mb-1">Academic Year 2025-2026 - Holistic Assessment</p>
                            <small class="text-success">Status: Available</small>
                            <div class="mt-2">
                                <a href="@Url.Action("MockExam", "Exam")" class="btn btn-primary btn-sm">
                                    <i class="fas fa-play"></i> Start Demo Exam
                                </a>
                                <small class="text-muted ml-2">
                                    <span>Demo exam with 5 sample questions</span>
                                </small>
                            </div>
                        </div>
                    </div>

                    @if (ViewBag.PublishedExams != null && ((List<HEMS.Models.Exam>)ViewBag.PublishedExams).Any())
                    {
                        <h6>Published Exams:</h6>
                        <div class="list-group">
                            @foreach (var exam in (List<HEMS.Models.Exam>)ViewBag.PublishedExams)
                            {
                                <div class="list-group-item">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">@exam.Title</h6>
                                        <small>Duration: @exam.DurationMinutes minutes</small>
                                    </div>
                                    <p class="mb-1">Academic Year @exam.AcademicYear - Holistic Assessment</p>
                                    <small class="text-success">Status: Available</small>
                                    <div class="mt-2">
                                        <button class="btn btn-success btn-sm" onclick="startExam(@exam.ExamId)">
                                            <i class="fas fa-play"></i> Start Real Exam
                                        </button>
                                        <small class="text-muted ml-2">
                                            <span>Questions: @(exam.Questions?.Count ?? 0) | Created: @exam.CreatedDate.ToString("MMM dd, yyyy")</span>
                                        </small>
                                    </div>
                                </div>
                            }
                        </div>
                        
                        <hr class="my-4">
                    }

                    @if (ViewBag.ErrorMessage != null)
                    {
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-exclamation-triangle"></i> Notice:</h6>
                            <p class="mb-0">@ViewBag.ErrorMessage</p>
                        </div>
                    }
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle"></i> Important Notes
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-clock"></i> Exam Guidelines:</h6>
                        <ul class="mb-0 small">
                            <li>Ensure stable internet connection</li>
                            <li>Do not refresh or close the browser during exam</li>
                            <li>Answers are auto-saved automatically</li>
                            <li>Submit exam before time expires</li>
                            <li>Contact coordinator for technical issues</li>
                        </ul>
                    </div>

                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> System Features:</h6>
                        <ul class="mb-0 small">
                            <li>Real-time countdown timer</li>
                            <li>Question flagging for review</li>
                            <li>Navigation between questions</li>
                            <li>Automatic submission at time limit</li>
                            <li>Immediate results after submission</li>
                        </ul>
                    </div>

                    <div class="text-center">
                        <a href="@Url.Action("StudentDashboard", "Home")" class="btn btn-secondary btn-sm">
                            <i class="fas fa-arrow-left"></i> Back to Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-question-circle"></i> Need Help?
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Technical Support:</h6>
                            <p>If you experience any technical difficulties during the examination:</p>
                            <ul>
                                <li>Raise your hand to alert the coordinator</li>
                                <li>Do not attempt to fix issues yourself</li>
                                <li>Your progress is automatically saved</li>
                                <li>The coordinator can assist with login or system issues</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Exam Procedures:</h6>
                            <p>Follow these procedures during your examination:</p>
                            <ul>
                                <li>Read all instructions carefully before starting</li>
                                <li>Use the question palette to navigate</li>
                                <li>Flag questions you want to review later</li>
                                <li>Submit your exam before the time limit</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function startExam(examId) {
    if (confirm('Are you ready to start the exam? Once started, the timer will begin and you cannot pause the exam.')) {
        // Create a form to POST to the exam start action
        var form = document.createElement('form');
        form.method = 'POST';
        form.action = '/Exam/Start';
        
        // Add exam ID parameter
        var examIdInput = document.createElement('input');
        examIdInput.type = 'hidden';
        examIdInput.name = 'examId';
        examIdInput.value = examId;
        form.appendChild(examIdInput);
        
        // Add anti-forgery token
        var token = document.querySelector('input[name="__RequestVerificationToken"]');
        if (token) {
            var tokenInput = document.createElement('input');
            tokenInput.type = 'hidden';
            tokenInput.name = '__RequestVerificationToken';
            tokenInput.value = token.value;
            form.appendChild(tokenInput);
        }
        
        // Submit form
        document.body.appendChild(form);
        form.submit();
    }
}
</script>