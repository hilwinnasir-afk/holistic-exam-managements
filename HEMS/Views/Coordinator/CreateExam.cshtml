@model HEMS.Models.ViewModels.ExamCreateViewModel
@{
    ViewBag.Title = "Create Exam";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-xl-8 col-lg-10 col-md-12">
            <!-- Header Section -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body bg-gradient-primary text-white rounded">
                    <div class="row align-items-center">
                        <div class="col">
                            <h1 class="h3 mb-2 text-white">
                                <i class="fas fa-plus-circle me-2"></i>Create New Exam
                            </h1>
                            <p class="mb-0 opacity-90">Set up a comprehensive examination with professional configuration options</p>
                        </div>
                        <div class="col-auto">
                            <div class="icon-shape bg-white bg-opacity-20 rounded-circle p-3">
                                <i class="fas fa-clipboard-list fa-2x text-white"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Form Card -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="card-title mb-0 text-dark">
                        <i class="fas fa-cog me-2 text-primary"></i>Exam Configuration
                    </h5>
                </div>
                <div class="card-body p-4">
                    @using (Html.BeginForm("CreateExam", "Coordinator", FormMethod.Post, new { @class = "needs-validation", novalidate = "novalidate" }))
                    {
                        @Html.AntiForgeryToken()
                        
                        <!-- Validation Summary -->
                        @if (!ViewData.ModelState.IsValid)
                        {
                            <div class="alert alert-danger border-0 shadow-sm mb-4" role="alert">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Please correct the following errors:</strong>
                                </div>
                                @Html.ValidationSummary(false, "", new { @class = "list-unstyled mt-2 mb-0 small" })
                            </div>
                        }

                        <div class="row g-4">
                            <!-- Exam Title -->
                            <div class="col-12">
                                <div class="form-floating">
                                    @Html.TextBoxFor(m => m.Title, new { 
                                        @class = "form-control form-control-lg", 
                                        placeholder = "Enter exam title",
                                        maxlength = "200"
                                    })
                                    @Html.LabelFor(m => m.Title, new { @class = "form-label" })
                                    @Html.ValidationMessageFor(m => m.Title, "", new { @class = "invalid-feedback d-block" })
                                </div>
                                <div class="form-text">
                                    <i class="fas fa-info-circle text-primary me-1"></i>
                                    Choose a descriptive title (e.g., "Software Engineering Final Exam 2024")
                                </div>
                            </div>

                            <!-- Academic Year and Duration Row -->
                            <div class="col-md-6">
                                <div class="form-floating">
                                    @Html.TextBoxFor(m => m.AcademicYear, new { 
                                        @class = "form-control", 
                                        type = "number", 
                                        min = "2000", 
                                        max = "2050",
                                        placeholder = "Academic Year"
                                    })
                                    @Html.LabelFor(m => m.AcademicYear, new { @class = "form-label" })
                                    @Html.ValidationMessageFor(m => m.AcademicYear, "", new { @class = "invalid-feedback d-block" })
                                </div>
                                <div class="form-text">
                                    <i class="fas fa-calendar-alt text-warning me-1"></i>
                                    <strong>Important:</strong> Only one exam per academic year
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-floating">
                                    @Html.TextBoxFor(m => m.DurationMinutes, new { 
                                        @class = "form-control", 
                                        type = "number", 
                                        min = "30", 
                                        max = "480",
                                        placeholder = "Duration in minutes"
                                    })
                                    @Html.LabelFor(m => m.DurationMinutes, new { @class = "form-label" })
                                    @Html.ValidationMessageFor(m => m.DurationMinutes, "", new { @class = "invalid-feedback d-block" })
                                </div>
                                <div class="form-text">
                                    <i class="fas fa-clock text-info me-1"></i>
                                    Recommended: 90-180 minutes for comprehensive exams
                                </div>
                            </div>

                            <!-- Date and Time Section -->
                            <div class="col-12">
                                <div class="card bg-light border-0">
                                    <div class="card-body p-3">
                                        <h6 class="card-title text-dark mb-3">
                                            <i class="fas fa-calendar-check me-2 text-success"></i>Exam Schedule
                                        </h6>
                                        
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label for="ExamStartDateTime" class="form-label fw-semibold">
                                                    <i class="fas fa-play-circle text-success me-1"></i>Start Date & Time
                                                </label>
                                                @Html.TextBoxFor(m => m.ExamStartDateTime, new { 
                                                    @class = "form-control form-control-lg", 
                                                    type = "datetime-local",
                                                    id = "ExamStartDateTime"
                                                })
                                                @Html.ValidationMessageFor(m => m.ExamStartDateTime, "", new { @class = "invalid-feedback d-block" })
                                                <div class="form-text">
                                                    <i class="fas fa-info-circle me-1"></i>When the exam becomes available to students
                                                </div>
                                            </div>

                                            <div class="col-md-6">
                                                <label for="ExamEndDateTime" class="form-label fw-semibold">
                                                    <i class="fas fa-stop-circle text-danger me-1"></i>End Date & Time
                                                </label>
                                                @Html.TextBoxFor(m => m.ExamEndDateTime, new { 
                                                    @class = "form-control form-control-lg", 
                                                    type = "datetime-local",
                                                    id = "ExamEndDateTime"
                                                })
                                                @Html.ValidationMessageFor(m => m.ExamEndDateTime, "", new { @class = "invalid-feedback d-block" })
                                                <div class="form-text">
                                                    <i class="fas fa-info-circle me-1"></i>When the exam closes and stops accepting submissions
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Same-day exam info -->
                                        <div class="alert alert-info border-0 mt-3 mb-0" role="alert">
                                            <div class="d-flex align-items-start">
                                                <i class="fas fa-lightbulb me-2 mt-1"></i>
                                                <div>
                                                    <strong>Same-day exams are supported!</strong><br>
                                                    <small>You can schedule exams on the same date with different times (e.g., 9:00 AM - 11:00 AM)</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="col-12">
                                <div class="d-flex flex-column flex-sm-row gap-3 justify-content-between align-items-center pt-3 border-top">
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary btn-lg px-4 shadow-sm">
                                            <i class="fas fa-plus-circle me-2"></i>Create Exam
                                        </button>
                                        <a href="@Url.Action("Index", "Coordinator")" class="btn btn-outline-secondary btn-lg px-4">
                                            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                                        </a>
                                    </div>
                                    <div class="text-muted small">
                                        <i class="fas fa-shield-alt me-1"></i>All fields are validated for security
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Guidelines Card -->
            <div class="card border-0 shadow-sm mt-4">
                <div class="card-header bg-white border-bottom">
                    <h5 class="card-title mb-0 text-dark">
                        <i class="fas fa-lightbulb me-2 text-warning"></i>Exam Creation Guidelines
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="d-flex align-items-start">
                                <div class="flex-shrink-0">
                                    <div class="icon-shape bg-success bg-opacity-10 text-success rounded p-2">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                </div>
                                <div class="ms-3">
                                    <h6 class="text-success mb-2">Best Practices</h6>
                                    <ul class="list-unstyled small text-muted mb-0">
                                        <li class="mb-1"><i class="fas fa-dot-circle me-2 text-success"></i>Use clear, descriptive exam titles</li>
                                        <li class="mb-1"><i class="fas fa-dot-circle me-2 text-success"></i>Set appropriate duration (1-2 minutes per question)</li>
                                        <li class="mb-1"><i class="fas fa-dot-circle me-2 text-success"></i>Plan for student reading and review time</li>
                                        <li class="mb-0"><i class="fas fa-dot-circle me-2 text-success"></i>Test the exam interface before publishing</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-start">
                                <div class="flex-shrink-0">
                                    <div class="icon-shape bg-info bg-opacity-10 text-info rounded p-2">
                                        <i class="fas fa-arrow-right"></i>
                                    </div>
                                </div>
                                <div class="ms-3">
                                    <h6 class="text-info mb-2">Next Steps</h6>
                                    <ul class="list-unstyled small text-muted mb-0">
                                        <li class="mb-1"><i class="fas fa-dot-circle me-2 text-info"></i>Add questions after creating the exam</li>
                                        <li class="mb-1"><i class="fas fa-dot-circle me-2 text-info"></i>Review all questions before publishing</li>
                                        <li class="mb-1"><i class="fas fa-dot-circle me-2 text-info"></i>Generate session passwords for exam day</li>
                                        <li class="mb-0"><i class="fas fa-dot-circle me-2 text-info"></i>Monitor exam sessions during testing</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .bg-gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .icon-shape {
        width: 3rem;
        height: 3rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .form-floating > .form-control:focus ~ label,
    .form-floating > .form-control:not(:placeholder-shown) ~ label {
        opacity: .65;
        transform: scale(.85) translateY(-.5rem) translateX(.15rem);
    }
    
    .card {
        transition: all 0.3s ease;
    }
    
    .card:hover {
        transform: translateY(-2px);
    }
    
    .btn {
        transition: all 0.2s ease;
    }
    
    .btn:hover {
        transform: translateY(-1px);
    }
    
    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    
    .alert {
        border-left: 4px solid;
    }
    
    .alert-info {
        border-left-color: #17a2b8;
    }
    
    .alert-danger {
        border-left-color: #dc3545;
    }
    
    @@media (max-width: 768px) {
        .container-fluid {
            padding-left: 1rem;
            padding-right: 1rem;
        }
        
        .card-body {
            padding: 1.5rem !important;
        }
        
        .btn-lg {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
        }
    }
</style>

@section Scripts {
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/dist/jquery.validate.unobtrusive.min.js"></script>
    
    <script>
        $(document).ready(function() {
            // Initialize tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Set default dates to tomorrow
            setDefaultDates();
            
            // Add real-time validation for exam date/time
            $('#ExamStartDateTime, #ExamEndDateTime').on('change blur', function() {
                validateExamTimes();
                updateDurationDisplay();
            });
            
            // Add input validation feedback
            $('.form-control').on('input change', function() {
                validateField($(this));
            });
            
            // Enhanced form validation before submission
            $('form').on('submit', function(e) {
                if (!validateForm()) {
                    e.preventDefault();
                    showValidationAlert();
                    return false;
                }
                
                // Show loading state
                showLoadingState();
            });
            
            // Character counter for title
            $('#Title').on('input', function() {
                updateCharacterCounter($(this), 200);
            });
        });
        
        function setDefaultDates() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const startDateTime = new Date(tomorrow);
            startDateTime.setHours(9, 0, 0, 0); // 9:00 AM
            
            const endDateTime = new Date(tomorrow);
            endDateTime.setHours(11, 0, 0, 0); // 11:00 AM
            
            const formatDateTime = (date) => {
                return date.toISOString().slice(0, 16);
            };
            
            if (!$('#ExamStartDateTime').val()) {
                $('#ExamStartDateTime').val(formatDateTime(startDateTime));
            }
            if (!$('#ExamEndDateTime').val()) {
                $('#ExamEndDateTime').val(formatDateTime(endDateTime));
            }
            
            updateDurationDisplay();
        }
        
        function validateExamTimes() {
            const startInput = $('#ExamStartDateTime');
            const endInput = $('#ExamEndDateTime');
            
            const startValue = startInput.val();
            const endValue = endInput.val();
            
            // Clear previous custom errors
            $('.custom-validation-error').remove();
            startInput.removeClass('is-invalid is-valid');
            endInput.removeClass('is-invalid is-valid');
            
            if (startValue && endValue) {
                const start = new Date(startValue);
                const end = new Date(endValue);
                const now = new Date();
                
                let hasError = false;
                
                // Check if start time is in the future
                if (start <= now) {
                    showFieldError(startInput, 'Exam start date and time must be in the future.');
                    hasError = true;
                }
                
                // Check if end time is after start time
                if (end <= start) {
                    let errorMessage;
                    if (start.toDateString() === end.toDateString()) {
                        errorMessage = 'End time must be after start time. Same-day exams are allowed with different times.';
                    } else {
                        errorMessage = 'End date and time must be after start date and time.';
                    }
                    showFieldError(endInput, errorMessage);
                    hasError = true;
                }
                
                if (!hasError) {
                    // Show success state
                    startInput.addClass('is-valid');
                    endInput.addClass('is-valid');
                    
                    // Check for warnings
                    const durationMinutes = (end - start) / (1000 * 60);
                    if (durationMinutes < 30) {
                        showFieldWarning(endInput, 'Warning: Exam duration is less than 30 minutes.');
                    }
                }
            }
            
            return !$('.is-invalid').length;
        }
        
        function updateDurationDisplay() {
            const startValue = $('#ExamStartDateTime').val();
            const endValue = $('#ExamEndDateTime').val();
            
            if (startValue && endValue) {
                const start = new Date(startValue);
                const end = new Date(endValue);
                
                if (end > start) {
                    const durationMinutes = (end - start) / (1000 * 60);
                    const hours = Math.floor(durationMinutes / 60);
                    const minutes = Math.floor(durationMinutes % 60);
                    
                    let durationText = '';
                    if (hours > 0) {
                        durationText += hours + 'h ';
                    }
                    if (minutes > 0) {
                        durationText += minutes + 'm';
                    }
                    
                    // Update duration field if it matches calculated duration
                    const calculatedDuration = Math.floor(durationMinutes);
                    $('#DurationMinutes').val(calculatedDuration);
                    
                    // Show duration info
                    $('.duration-info').remove();
                    $('#ExamEndDateTime').after(`
                        <div class="duration-info small text-success mt-1">
                            <i class="fas fa-clock me-1"></i>Calculated duration: ${durationText} (${calculatedDuration} minutes)
                        </div>
                    `);
                }
            }
        }
        
        function validateField(field) {
            const value = field.val().trim();
            const fieldName = field.attr('name');
            
            field.removeClass('is-invalid is-valid');
            field.siblings('.custom-validation-error').remove();
            
            // Basic validation
            if (field.prop('required') && !value) {
                showFieldError(field, `${fieldName} is required.`);
                return false;
            }
            
            // Specific field validation
            switch (fieldName) {
                case 'Title':
                    if (value.length < 5) {
                        showFieldError(field, 'Title must be at least 5 characters long.');
                        return false;
                    }
                    break;
                case 'AcademicYear':
                    const year = parseInt(value);
                    if (year < 2000 || year > 2050) {
                        showFieldError(field, 'Academic year must be between 2000 and 2050.');
                        return false;
                    }
                    break;
                case 'DurationMinutes':
                    const duration = parseInt(value);
                    if (duration < 30 || duration > 480) {
                        showFieldError(field, 'Duration must be between 30 and 480 minutes.');
                        return false;
                    }
                    break;
            }
            
            field.addClass('is-valid');
            return true;
        }
        
        function showFieldError(field, message) {
            field.addClass('is-invalid');
            field.after(`<div class="custom-validation-error invalid-feedback d-block">${message}</div>`);
        }
        
        function showFieldWarning(field, message) {
            field.after(`<div class="custom-validation-error text-warning small mt-1"><i class="fas fa-exclamation-triangle me-1"></i>${message}</div>`);
        }
        
        function updateCharacterCounter(field, maxLength) {
            const currentLength = field.val().length;
            const remaining = maxLength - currentLength;
            
            $('.char-counter').remove();
            field.after(`<div class="char-counter small text-muted mt-1">${currentLength}/${maxLength} characters</div>`);
            
            if (remaining < 20) {
                $('.char-counter').addClass('text-warning');
            }
            if (remaining < 0) {
                $('.char-counter').addClass('text-danger');
            }
        }
        
        function validateForm() {
            let isValid = true;
            
            // Validate all required fields
            $('.form-control[required]').each(function() {
                if (!validateField($(this))) {
                    isValid = false;
                }
            });
            
            // Validate exam times
            if (!validateExamTimes()) {
                isValid = false;
            }
            
            return isValid;
        }
        
        function showValidationAlert() {
            const alertHtml = `
                <div class="alert alert-danger border-0 shadow-sm alert-dismissible fade show" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Please correct the validation errors before submitting.</strong>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            $('.card-body').prepend(alertHtml);
            
            // Scroll to first error
            const firstError = $('.is-invalid').first();
            if (firstError.length) {
                $('html, body').animate({
                    scrollTop: firstError.offset().top - 100
                }, 500);
                firstError.focus();
            }
        }
        
        function showLoadingState() {
            const submitBtn = $('button[type="submit"]');
            const originalText = submitBtn.html();
            
            submitBtn.prop('disabled', true);
            submitBtn.html('<i class="fas fa-spinner fa-spin me-2"></i>Creating Exam...');
            
            // Restore button after 10 seconds (fallback)
            setTimeout(() => {
                submitBtn.prop('disabled', false);
                submitBtn.html(originalText);
            }, 10000);
        }
    </script>
}